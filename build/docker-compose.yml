name: turtle-app

services:
  mcp-qbittorrent:
    build:
      context: ../mcp-servers/qbittorrent-mcp
      dockerfile: Dockerfile
    image: turtle-app/mcp-qbittorrent:latest
    container_name: turtle-mcp-qbittorrent
    environment:
      # Connect to external qBittorrent container via host
      # On Mac/Windows: host.docker.internal works
      # On Linux: use host IP or add qbittorrent container to turtle-network
      - TURTLEAPP_QB_QBITTORRENT_URL=${QBITTORRENT_URL:-http://host.docker.internal:8100}
      - TURTLEAPP_QB_QBITTORRENT_USERNAME=admin
      - TURTLEAPP_QB_QBITTORRENT_PASSWORD=${QB_PASSWORD:-adminadmin}
    ports:
      - 8201:8000
    restart: unless-stopped
    networks:
      - turtle-network
      - default
    extra_hosts:
      # Allow host.docker.internal to work on Linux too
      - "host.docker.internal:host-gateway"
    healthcheck:
      # Use Python instead of curl (curl not installed in container)
      test: ["CMD", ".venv/bin/python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/mcp/tools').read()"]
      interval: 30s
      timeout: 10s
      retries: 3

  turtle-app-api:
    build:
      context: ..
      dockerfile: build/Dockerfile_api
    image: turtle-app/api:latest
    container_name: turtle-api-server
    # Optional: uncomment if .env.local exists
    # env_file:
    #   - ../.env.local
    environment:
      - TURTLEAPP_MCP_QBITTORRENT_URL=http://turtle-mcp-qbittorrent:8000/mcp
      - SAMBA_SHARE_PATH=${SAMBA_SHARE_PATH:-daves}
      # Samba connection - adjust if needed for external Samba container
      - SAMBA_SERVER=${SAMBA_SERVER:-host.docker.internal}
    ports:
      - 8202:8000
    restart: unless-stopped
    networks:
      - turtle-network
      - default
    extra_hosts:
      # Allow host.docker.internal to work on Linux too
      - "host.docker.internal:host-gateway"
    depends_on:
      mcp-qbittorrent:
        condition: service_healthy

networks:
  turtle-network:
    driver: bridge
    attachable: true
    ipam:
      driver: default
  default:
    external: true
    name: homeserver-media_default
