services:

  qbittorrent:
    image: linuxserver/qbittorrent
    container_name: qbittorrent
    environment:
      - PUID=1000
      - PGID=1000
      - UMASK_SET=022
      - WEBUI_PORT=15080
    volumes:
      - ${STACK_PATH:-./volumes}/qbittorrent/config:/config
      - ${HDD_PATH:-./downloads}:/downloads
    ports:
      - 6881:6881
      - 6881:6881/udp
      - 15080:15080
      - 1080:1080
    restart: unless-stopped

  # NEW: MCP Server (separate container with HTTP endpoint)
  mcp-qbittorrent:
    build:
      context: ../mcp-servers/qbittorrent-mcp
      dockerfile: Dockerfile
    container_name: mcp-qbittorrent
    environment:
      # MCP server connects to qBittorrent
      - TURTLEAPP_QB_QBITTORRENT_URL=http://qbittorrent:15080
      - TURTLEAPP_QB_QBITTORRENT_USERNAME=admin
      - TURTLEAPP_QB_QBITTORRENT_PASSWORD=${QB_PASSWORD:-adminadmin}
    ports:
      - "8001:8000"  # Expose HTTP endpoint for debugging
    depends_on:
      - qbittorrent
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/mcp/tools"]
      interval: 30s
      timeout: 10s
      retries: 3

  nas:
    image: dperson/samba
    container_name: samba
    environment:
      - TZ=${TZ:-UTC}
    networks:
      - default
    ports:
      - 1139:139
      - 1445:445
    restart: unless-stopped
    stdin_open: true
    tty: true
    volumes:
      - ${HDD_PATH:-./downloads}:/downloads
    command: >
      -s "${SAMBA_SHARE_PATH:-daves};/downloads;yes;no;no"
      -u "${SAMBA_USER:-dave};${SAMBA_PASSWORD:-password}"
      -w "WORKGROUP"

  # UPDATED: Turtle App (connects to MCP server via HTTP)
  turtle-app-api:
    build:
      context: ..
      dockerfile: build/Dockerfile_api
    container_name: turtle-app-api
    env_file:
      - ../.env.local
    environment:
      # MCP server URL (HTTP transport)
      - TURTLEAPP_MCP_QBITTORRENT_URL=http://mcp-qbittorrent:8000/mcp

      # Other existing env vars
      - SAMBA_SHARE_PATH=${SAMBA_SHARE_PATH:-daves}
    ports:
      - 8000:8000
    restart: unless-stopped
    networks:
      - default
    depends_on:
      mcp-qbittorrent:
        condition: service_healthy
      nas:
        condition: service_started

networks:
  default:
    driver: bridge
    attachable: true
    ipam:
      driver: default
