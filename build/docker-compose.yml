name: turtle-app

services:

  # qbittorrent:
  #   image: linuxserver/qbittorrent
  #   container_name: qbittorrent-server
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #     - UMASK_SET=022
  #     - WEBUI_PORT=15080
  #   volumes:
  #     - ${STACK_PATH:-./volumes}/qbittorrent/config:/config
  #     - ${HDD_PATH:-./downloads}:/downloads
  #   ports:
  #     - 6881:6881
  #     - 6881:6881/udp
  #     - 15080:15080
  #     - 1080:1080
  #   restart: unless-stopped
  
  # nas:
  #   image: dperson/samba
  #   container_name: samba
  #   environment:
  #     - TZ=${TZ:-UTC}
  #   networks:
  #     - default
  #   ports:
  #     - 1139:139
  #     - 1445:445
  #   restart: unless-stopped
  #   stdin_open: true
  #   tty: true
  #   volumes:
  #     - ${HDD_PATH:-./downloads}:/downloads
  #   command: >
  #     -s "${SAMBA_SHARE_PATH:-daves};/downloads;yes;no;no"
  #     -u "${SAMBA_USER:-dave};${SAMBA_PASSWORD:-password}"
  #     -w "WORKGROUP"
  
  mcp-qbittorrent:
    build:
      context: ../mcp-servers/qbittorrent-mcp
      dockerfile: Dockerfile
    image: turtle-app/mcp-qbittorrent:latest
    container_name: turtle-mcp-qbittorrent
    environment:
      - TURTLEAPP_QB_QBITTORRENT_URL=http://qbittorrent:15080
      - TURTLEAPP_QB_QBITTORRENT_USERNAME=admin
      - TURTLEAPP_QB_QBITTORRENT_PASSWORD=${QB_PASSWORD:-adminadmin}
    ports:
      - 9001:8000
    restart: unless-stopped
    networks:
      - turtle-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/mcp/tools"]
      interval: 30s
      timeout: 10s
      retries: 3
    # depends_on:
    #   - qbittorrent


  turtle-app-api:
    build:
      context: ..
      dockerfile: build/Dockerfile_api
    image: turtle-app/api:latest
    container_name: turtle-api-server
    env_file:
      - ../.env.local
    environment:
      - TURTLEAPP_MCP_QBITTORRENT_URL=http://turtle-mcp-qbittorrent:8000/mcp
      - SAMBA_SHARE_PATH=${SAMBA_SHARE_PATH:-daves}
    ports:
      - 9002:8000
    restart: unless-stopped
    networks:
      - turtle-network
    depends_on:
      mcp-qbittorrent:
        condition: service_healthy
      # nas:
      #   condition: service_started

networks:
  turtle-network:
    driver: bridge
    attachable: true
    ipam:
      driver: default
